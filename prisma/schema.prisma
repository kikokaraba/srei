// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
  // Force regeneration - v2
}

datasource db {
  provider = "postgresql"
}

// Coordinates are stored as latitude/longitude (Float) instead of PostGIS
// This works with all PostgreSQL versions without requiring PostGIS extension

enum UserRole {
  ADMIN
  PREMIUM_INVESTOR
  FREE_USER
}

// SlovakCity enum removed - now using String for city field
// This allows storing any city/village name from Slovakia (2900+ locations)

enum PropertyCondition {
  POVODNY        // Original
  REKONSTRUKCIA  // Renovated
  NOVOSTAVBA     // New construction
}

enum EnergyCertificate {
  A
  B
  C
  D
  E
  F
  G
  NONE
}

enum ListingType {
  PREDAJ    // Sale
  PRENAJOM  // Rent
}

enum PropertySource {
  BAZOS         // reality.bazos.sk
  NEHNUTELNOSTI // nehnutelnosti.sk
  REALITY       // reality.sk
  TOPREALITY    // topreality.sk
  MANUAL        // Manuálne pridané
}

enum PortfolioPropertyStatus {
  OWNED        // Vlastnená
  SOLD         // Predaná
  RENTED       // Prenajatá
  VACANT       // Prázdna
  RENOVATING   // V rekonštrukcii
}

enum TransactionType {
  PURCHASE          // Kúpa
  SALE              // Predaj
  RENT_INCOME       // Príjem z nájmu
  MAINTENANCE       // Údržba
  RENOVATION        // Rekonštrukcia
  TAX               // Daň z nehnuteľnosti
  INSURANCE         // Poistenie
  MORTGAGE_PAYMENT  // Splátka hypotéky
  UTILITIES         // Energie (ak platí majiteľ)
  MANAGEMENT_FEE    // Správa nehnuteľnosti
  OTHER_INCOME      // Iný príjem
  OTHER_EXPENSE     // Iný výdavok
}

enum InfrastructureType {
  METRO_STATION
  TRAM_STATION
  HIGHWAY
  SHOPPING_CENTER
  SCHOOL
  HOSPITAL
  PARK
  BUSINESS_DISTRICT
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?  // Hashované heslo (bcrypt)
  emailVerified DateTime?
  name          String?
  image         String?
  role          UserRole  @default(FREE_USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  properties    Property[]
  savedProperties SavedProperty[]
  dashboardLayout DashboardLayout?
  preferences   UserPreferences?
  portfolioProperties PortfolioProperty[]
  apiKeys       ApiKey[]
  subscription  Subscription?
}

// API kľúče pre verejné API (Pro/Enterprise)
model ApiKey {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String    // Názov kľúča (napr. "Production", "Development")
  key         String    @unique // Samotný API kľúč (hash)
  prefix      String    // Prvých 8 znakov pre identifikáciu (sria_xxxx)
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime? // Voliteľná expirácia
  permissions String    @default("read") // "read", "read,write"
  rateLimit   Int       @default(100) // Requesty za hodinu
  createdAt   DateTime  @default(now())
  
  @@index([key])
  @@index([userId])
}

// Predplatné používateľa
model Subscription {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          String    // "FREE", "PREMIUM", "ENTERPRISE"
  status        String    // "ACTIVE", "CANCELLED", "PAST_DUE", "TRIALING"
  stripeCustomerId    String?
  stripeSubscriptionId String?
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Property {
  id                String            @id @default(cuid())
  slug              String            @unique
  external_id       String?           // ID z pôvodného portálu
  source            PropertySource    @default(BAZOS) // Zdroj inzerátu
  title             String
  description       String?          @db.Text
  city              String            // Mesto/obec (napr. "Bratislava", "Poprad", "Tvrdošín")
  district          String            // mestska cast / okres
  street            String?           // Názov ulice pre Market Gaps analýzu
  address           String
  latitude          Float?  // Latitude (súradnica)
  longitude         Float?  // Longitude (súradnica)
  price             Float
  area_m2           Float
  price_per_m2      Float
  rooms             Int?
  floor             Int?
  condition         PropertyCondition
  energy_certificate EnergyCertificate
  listing_type      ListingType       @default(PREDAJ) // Predaj alebo prenájom
  source_url        String?          @db.Text
  is_distressed     Boolean          @default(false)
  days_on_market    Int              @default(0) // Počet dní v ponuke
  first_listed_at   DateTime?        // Kedy bol prvýkrát zverejnený
  
  // Fotky a médiá
  photos            String           @db.Text @default("[]") // JSON array of photo URLs
  thumbnail_url     String?          // Hlavná fotka pre rýchle načítanie
  photo_count       Int              @default(0) // Počet fotiek pre matching
  
  // Kontaktné údaje pre matching duplicít
  seller_name       String?          // Meno predávajúceho
  seller_phone      String?          // Telefón (normalizovaný)
  seller_type       String?          // "owner", "agency", "developer"
  
  // Monitoring fields for smart refresh system
  last_seen_at      DateTime         @default(now()) // Kedy bol naposledy videný pri scrapingu
  status            ListingStatus    @default(ACTIVE) // Stav inzerátu
  priority_score    Int              @default(50) // Priorita pre refresh (0-100, vyššia = častejšia kontrola)
  check_count_today Int              @default(0) // Koľkokrát bol dnes skontrolovaný
  last_checked_at   DateTime?        // Kedy bol naposledy skontrolovaný batch workerom
  consecutive_failures Int           @default(0) // Počet po sebe idúcich chýb pri kontrole
  
  @@index([source, external_id])
  @@index([source, city])
  @@index([city, listing_type, price])
  @@index([city, area_m2, condition])
  @@index([is_distressed, createdAt])
  @@index([listing_type, createdAt])
  @@index([status, priority_score]) // Pre batch refresh - najprv vysoká priorita
  @@index([status, last_checked_at]) // Pre batch refresh - najstaršie kontroly
  @@index([status, check_count_today]) // Pre denný limit kontrol
  @@index([last_seen_at]) // Pre detekciu predaných
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  userId            String?
  user              User?            @relation(fields: [userId], references: [id])
  investmentMetrics InvestmentMetrics?
  priceHistory      PriceHistory[]
  marketGaps        MarketGap[]
  propertyImpacts   PropertyImpact[]
  taxInfo           TaxInfo?
  savedBy           SavedProperty[]
  snapshots         PropertySnapshot[]
  fingerprint       PropertyFingerprint?
  primaryMatches    PropertyMatch[] @relation("PrimaryProperty")
  matchedBy         PropertyMatch[] @relation("MatchedProperty")
}

model MarketAnalytics {
  id              String   @id @default(cuid())
  city            String
  avg_price_m2    Float
  avg_rent_m2     Float
  yield_benchmark Float    // Average yield percentage
  volatility_index Float   // Risk metric (0-1)
  timestamp       DateTime @default(now())

  @@index([city, timestamp])
}

model InvestmentMetrics {
  id                String   @id @default(cuid())
  propertyId        String   @unique
  property          Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  gross_yield       Float    // Annual rent / purchase price
  net_yield         Float    // After expenses
  cash_on_cash      Float    // Cash return on investment
  price_to_rent_ratio Float  // Price / annual rent
  calculated_at     DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Sledovanie zmien cien nehnuteľností (pre Liquidity Tracker)
model PriceHistory {
  id          String   @id @default(cuid())
  propertyId String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  price       Float
  price_per_m2 Float
  recorded_at DateTime @default(now())
  
  @@index([propertyId, recorded_at])
}

// Analýza priemerných cien v uliciach (pre Market Gaps)
model StreetAnalytics {
  id              String   @id @default(cuid())
  city            String
  district        String
  street          String
  avg_price_m2    Float
  median_price_m2 Float
  property_count  Int      @default(0)
  last_updated    DateTime @default(now())
  
  @@unique([city, district, street])
  @@index([city, district])
}

// Detekované podhodnotené nehnuteľnosti (Market Gaps)
model MarketGap {
  id                String   @id @default(cuid())
  propertyId        String
  property          Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  gap_percentage    Float    // O koľko % je podhodnotená (napr. 15.5)
  potential_profit  Float?   // Odhadovaný potenciálny zisk pri flipe
  street_avg_price  Float    // Priemerná cena v ulici
  detected_at       DateTime @default(now())
  notified          Boolean  @default(false) // Či už bola poslaná notifikácia
  notified_at       DateTime?
  
  @@unique([propertyId])
  @@index([detected_at, notified])
}

model UrbanDevelopment {
  id              String            @id @default(cuid())
  name            String            // Názov projektu (napr. "Stanica metra Nové Mesto")
  type            InfrastructureType
  city            String
  district        String
  latitude        Float?  // Latitude (súradnica)
  longitude       Float?  // Longitude (súradnica)
  planned_start   DateTime?         // Plánovaný začiatok výstavby
  planned_completion DateTime?      // Plánované dokončenie
  status          String            // "planned", "in_progress", "completed"
  description     String?          @db.Text
  expected_impact Float?           // Očakávaný vplyv na ceny v % (napr. +20%)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  propertyImpacts PropertyImpact[]
}

// Vplyv urbanistického rozvoja na nehnuteľnosti
model PropertyImpact {
  id                  String          @id @default(cuid())
  propertyId          String
  property            Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  urbanDevelopmentId  String
  urbanDevelopment    UrbanDevelopment @relation(fields: [urbanDevelopmentId], references: [id], onDelete: Cascade)
  distance_meters     Float           // Vzdialenosť od infraštruktúry v metroch
  estimated_appreciation Float?       // Odhadované zhodnotenie v % (napr. +15%)
  notes               String?        @db.Text
  createdAt           DateTime        @default(now())
  
  @@unique([propertyId, urbanDevelopmentId])
  @@index([propertyId])
  @@index([urbanDevelopmentId])
}

// Daňové a právne informácie pre nehnuteľnosti
model TaxInfo {
  id                    String   @id @default(cuid())
  propertyId            String   @unique
  property              Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  purchase_date         DateTime
  purchase_price        Float
  is_primary_residence  Boolean  @default(false) // Hlavné bydlisko
  ownership_type        String   // "individual", "sro", "spolocnost"
  depreciation_group    Int?     // Odpisová skupina pre s.r.o. (1-6)
  tax_exemption_date    DateTime? // Kedy uplynie 5-ročný test
  calculated_at         DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// Dashboard layout pre každého používateľa
model DashboardLayout {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  widgets   String   @db.Text // JSON array of widget IDs in order
  hiddenWidgets String @db.Text // JSON array of hidden widget IDs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Uložené/sledované nehnuteľnosti používateľom
model SavedProperty {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  notes       String?  @db.Text  // Poznámky používateľa
  isFavorite  Boolean  @default(false)  // Obľúbená
  alertOnChange Boolean @default(true)  // Upozorniť na zmeny
  savedAt     DateTime @default(now())
  
  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

// Snímka nehnuteľnosti v čase - pre sledovanie zmien
model PropertySnapshot {
  id          String   @id @default(cuid())
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Kópia dát v čase snímky
  title       String
  description String?  @db.Text
  price       Float
  price_per_m2 Float
  photos      String   @db.Text  // JSON array of photo URLs
  source_url  String?  @db.Text
  
  // Zmeny oproti predchádzajúcej snímke
  priceChange     Float?   // Zmena ceny v €
  priceChangePercent Float? // Zmena ceny v %
  photosChanged   Boolean  @default(false)  // Zmenili sa fotky?
  descriptionChanged Boolean @default(false)  // Zmenil sa popis?
  
  snapshotAt  DateTime @default(now())
  
  @@index([propertyId, snapshotAt])
}

// Fingerprint nehnuteľnosti pre matching duplicít
model PropertyFingerprint {
  id          String   @id @default(cuid())
  propertyId  String   @unique
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Normalizované hodnoty pre matching
  addressNormalized String   // Normalizovaná adresa (lowercase, bez diakritiky)
  cityDistrict      String   // "BRATISLAVA-Staré Mesto"
  areaRange         String   // "50-60" (zaokrúhlené na desiatky)
  roomsRange        String?  // "2" alebo "2-3"
  priceRange        String?  // "100000-150000" (zaokrúhlené)
  floorRange        String?  // "1-3" alebo "4+"
  
  // Textové patterny pre AI matching
  titleNormalized   String?  // Normalizovaný názov
  descriptionHash   String?  // Hash z prvých 500 znakov popisu
  
  // Hash pre rýchle porovnanie
  fingerprintHash   String   // MD5 hash z normalizovaných hodnôt
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([fingerprintHash])
  @@index([cityDistrict, areaRange])
  @@index([cityDistrict, priceRange])
}

// Prepojenie duplicitných/rovnakých nehnuteľností
model PropertyMatch {
  id              String   @id @default(cuid())
  primaryPropertyId   String
  primaryProperty     Property @relation("PrimaryProperty", fields: [primaryPropertyId], references: [id], onDelete: Cascade)
  matchedPropertyId   String
  matchedProperty     Property @relation("MatchedProperty", fields: [matchedPropertyId], references: [id], onDelete: Cascade)
  
  matchScore      Float    // Skóre zhody (0-100)
  matchReason     String   @db.Text  // JSON: prečo sa zhodujú
  isConfirmed     Boolean  @default(false)  // Potvrdené používateľom
  confirmedBy     String?  // userId kto potvrdil
  
  createdAt       DateTime @default(now())
  
  @@unique([primaryPropertyId, matchedPropertyId])
  @@index([primaryPropertyId])
  @@index([matchedPropertyId])
}

// User preferences - onboarding a filtre
model UserPreferences {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  onboardingCompleted   Boolean  @default(false)
  
  // Lokalita
  primaryCity           String? // Hlavné mesto záujmu (legacy - pre spätnú kompatibilitu)
  trackedRegions        String   @default("[]") @db.Text // JSON array of region IDs (BA, KE, etc.)
  trackedCities         String   @default("[]") @db.Text // JSON array of city names
  trackedDistricts      String   @default("[]") @db.Text // JSON array of district IDs
  trackedStreets        String   @db.Text // JSON array of street names
  
  // Typ investície
  investmentType        String?  // Legacy: "future-potential", "high-yield", "stable-growth", "flip", "rental"
  investmentTypes       String   @default("[]") @db.Text // JSON array of investment types
  minYield              Float?   // Minimálny požadovaný výnos
  maxYield              Float?   // Maximálny výnos
  minPrice              Float?   // Minimálna cena
  maxPrice              Float?   // Maximálna cena
  minPricePerM2         Float?   // Minimálna cena za m²
  maxPricePerM2         Float?   // Maximálna cena za m²
  minArea               Float?   // Minimálna plocha v m²
  maxArea               Float?   // Maximálna plocha v m²
  
  // Nehnuteľnosť
  propertyTypes         String   @db.Text // JSON array: ["apartment", "house", "studio", "commercial"]
  minRooms              Int?     // Minimálny počet izieb
  maxRooms              Int?     // Maximálny počet izieb
  condition             String   @db.Text // JSON array of PropertyCondition
  energyCertificates    String   @db.Text // JSON array of EnergyCertificate
  minFloor              Int?     // Minimálne poschodie
  maxFloor              Int?     // Maximálne poschodie
  onlyDistressed        Boolean  @default(false) // Len nehnuteľnosti v núdzi
  
  // Investičné metriky
  minGrossYield         Float?   // Minimálny hrubý výnos
  maxGrossYield         Float?   // Maximálny hrubý výnos
  minNetYield           Float?   // Minimálny čistý výnos
  maxNetYield           Float?   // Maximálny čistý výnos
  minCashOnCash         Float?   // Minimálny cash-on-cash return
  maxCashOnCash         Float?   // Maximálny cash-on-cash return
  maxPriceToRentRatio   Float?   // Maximálny pomer cena/nájom
  
  // Trhové podmienky
  maxDaysOnMarket       Int?     // Maximálny počet dní v ponuke
  minPriceDrop          Float?   // Minimálny pokles ceny v %
  requirePriceHistory   Boolean  @default(false) // Vyžadovať históriu cien
  
  // Urban Development
  minUrbanImpact        Float?   // Minimálny očakávaný vplyv urban development v %
  maxDistanceToInfra    Float?   // Maximálna vzdialenosť k infraštruktúre v metroch
  infrastructureTypes   String   @db.Text // JSON array of InfrastructureType
  
  // Market Gaps
  minGapPercentage      Float?   // Minimálny gap percentage (napr. 10%)
  minPotentialProfit    Float?   // Minimálny potenciálny zisk
  
  // Daňové preferencie
  ownershipTypes        String   @db.Text // JSON array: ["individual", "sro", "spolocnost"]
  requireTaxExemption   Boolean  @default(false) // Vyžadovať daňové oslobodenie
  
  // Notifikácie
  notifyMarketGaps      Boolean  @default(true)
  notifyPriceDrops      Boolean  @default(true)
  notifyNewProperties   Boolean  @default(true)
  notifyUrbanDevelopment Boolean @default(true)
  notifyHighYield       Boolean  @default(false) // Upozornenia na vysoký výnos
  notifyDistressed      Boolean  @default(false) // Upozornenia na nehnuteľnosti v núdzi
  notificationFrequency String?  @default("daily") // "realtime", "hourly", "daily", "weekly"
  
  // Telegram integrácia (Pro funkcia)
  telegramChatId        String?  // Chat ID pre Telegram notifikácie
  telegramUsername      String?  // Telegram username
  telegramConnectedAt   DateTime? // Kedy bol Telegram pripojený
  telegramEnabled       Boolean  @default(false) // Či sú Telegram notifikácie zapnuté
  
  // Dashboard preferences
  defaultView           String?  @default("dashboard") // "dashboard", "map", "list"
  itemsPerPage          Int?     @default(20) // Počet položiek na stránku
  sortBy                String?  @default("price") // "price", "yield", "area", "date"
  sortOrder             String?  @default("asc") // "asc", "desc"
  
  // Filter presets
  savedFilters          String   @db.Text // JSON array of saved filter presets
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ==========================================
// PORTFÓLIO INVESTORA
// ==========================================

// Nehnuteľnosť v portfóliu používateľa
model PortfolioProperty {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Základné info
  name            String   // Vlastný názov (napr. "Byt Petržalka")
  address         String
  city            String
  district        String?
  
  // Nehnuteľnosť
  propertyType    String   // "apartment", "house", "studio", "commercial", "land"
  area_m2         Float
  rooms           Int?
  floor           Int?
  
  // Nákup
  purchaseDate    DateTime
  purchasePrice   Float
  purchaseCosts   Float    @default(0) // Náklady na kúpu (právnik, daň, atď.)
  
  // Predaj (ak predané)
  saleDate        DateTime?
  salePrice       Float?
  saleCosts       Float?   // Náklady na predaj
  
  // Aktuálna hodnota
  currentValue    Float    // Odhadovaná aktuálna hodnota
  lastValuationDate DateTime @default(now())
  
  // Hypotéka
  hasMortgage     Boolean  @default(false)
  mortgageAmount  Float?   // Výška hypotéky
  mortgageRate    Float?   // Úroková sadzba (%)
  mortgagePayment Float?   // Mesačná splátka
  mortgageStart   DateTime?
  mortgageEnd     DateTime?
  
  // Prenájom
  isRented        Boolean  @default(false)
  monthlyRent     Float?   // Mesačný nájom
  tenantName      String?
  leaseStart      DateTime?
  leaseEnd        DateTime?
  depositAmount   Float?   // Kaucia
  
  // Náklady
  monthlyExpenses Float    @default(0) // Priemerné mesačné náklady
  annualTax       Float?   // Ročná daň z nehnuteľnosti
  annualInsurance Float?   // Ročné poistenie
  
  // Status
  status          PortfolioPropertyStatus @default(OWNED)
  notes           String?  @db.Text
  
  // Fotky
  photos          String   @db.Text @default("[]") // JSON array of photo URLs
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  transactions    PortfolioTransaction[]
  valuations      PropertyValuation[]
  
  @@index([userId])
  @@index([userId, status])
}

// Transakcie (príjmy a výdavky)
model PortfolioTransaction {
  id              String   @id @default(cuid())
  portfolioPropertyId String
  portfolioProperty   PortfolioProperty @relation(fields: [portfolioPropertyId], references: [id], onDelete: Cascade)
  
  type            TransactionType
  amount          Float    // Kladná = príjem, záporná = výdavok
  date            DateTime
  description     String?
  category        String?  // Vlastná kategória
  
  // Pre opakujúce sa transakcie
  isRecurring     Boolean  @default(false)
  recurringFrequency String? // "monthly", "quarterly", "yearly"
  
  createdAt       DateTime @default(now())
  
  @@index([portfolioPropertyId])
  @@index([portfolioPropertyId, date])
  @@index([portfolioPropertyId, type])
}

// História oceňovania nehnuteľnosti
model PropertyValuation {
  id              String   @id @default(cuid())
  portfolioPropertyId String
  portfolioProperty   PortfolioProperty @relation(fields: [portfolioPropertyId], references: [id], onDelete: Cascade)
  
  value           Float
  source          String?  // "manual", "market", "appraisal"
  notes           String?
  valuationDate   DateTime @default(now())
  
  @@index([portfolioPropertyId, valuationDate])
}

// ==========================================
// EXTERNÉ DÁTOVÉ ZDROJE
// ==========================================

// Slovenský kraj
enum SlovakRegion {
  BRATISLAVSKY
  TRNAVSKY
  TRENCIANSKY
  NITRIANSKY
  ZILINSKY
  BANSKOBYSTRICKY
  PRESOVSKY
  KOSICKY
}

// Typ nehnuteľnosti pre NBS dáta
enum NBSPropertyType {
  APARTMENT
  HOUSE
  ALL
}

// NBS Ceny nehnuteľností - štvrťročné dáta
model NBSPropertyPrice {
  id            String   @id @default(cuid())
  year          Int
  quarter       Int      // 1-4
  region        SlovakRegion
  propertyType  NBSPropertyType
  pricePerSqm   Float    // EUR/m²
  priceIndex    Float    // Index (100 = base year)
  changeYoY     Float    // % zmena medziročne
  changeQoQ     Float    // % zmena medzištvrťročne
  fetchedAt     DateTime @default(now())
  
  @@unique([year, quarter, region, propertyType])
  @@index([region, year, quarter])
}

// Ekonomické ukazovatele
model EconomicIndicator {
  id                  String   @id @default(cuid())
  date                DateTime
  gdpGrowth           Float    // % medziročne
  inflation           Float    // % medziročne
  unemployment        Float    // %
  avgWage             Float    // EUR
  wageGrowth          Float    // % medziročne
  constructionIndex   Float    // Index (100 = base year)
  consumerConfidence  Float    // Balance
  mortgageRate        Float?   // Priemerná hypotekárna sadzba
  fetchedAt           DateTime @default(now())
  
  @@index([date])
}

// Demografické dáta miest
model CityDemographics {
  id              String     @id @default(cuid())
  city            String
  year            Int
  population      Int
  populationChange Float     // % zmena
  avgAge          Float
  householdCount  Int?
  avgHouseholdSize Float?
  migrationBalance Int?      // Čistá migrácia
  fetchedAt       DateTime   @default(now())
  
  @@unique([city, year])
  @@index([city])
}

// Trhové dáta pre mestá - agregované
model CityMarketData {
  id                String     @id @default(cuid())
  city              String
  date              DateTime   // Dátum aktualizácie
  
  // Ceny
  avgPricePerSqm    Float
  medianPricePerSqm Float
  priceChangeYoY    Float      // % zmena medziročne
  priceChangeQoQ    Float      // % zmena medzištvrťročne
  
  // Prenájom
  avgRentPerSqm     Float?
  grossYield        Float?     // %
  
  // Trh
  listingsCount     Int
  avgDaysOnMarket   Int
  demandIndex       Float      // 0-100
  supplyIndex       Float      // 0-100
  
  fetchedAt         DateTime   @default(now())
  
  @@index([city, date])
}

// Log zberu dát
model DataFetchLog {
  id          String   @id @default(cuid())
  source      String   // "NBS", "SUSR", "scraper"
  status      String   // "success", "error", "partial"
  recordsCount Int?
  error       String?  @db.Text
  duration_ms Int?
  fetchedAt   DateTime @default(now())
  
  @@index([source, fetchedAt])
}

// Progres scrapingu - sleduje kde scraper skončil
model ScrapeProgress {
  id              String   @id @default(cuid())
  source          String   @unique // "NEHNUTELNOSTI", "BAZOS", etc.
  
  // Pozícia
  currentPage     Int      @default(1)
  totalPages      Int      @default(775) // Odhadovaný počet stránok
  category        String   @default("byty-predaj") // Aktuálna kategória
  
  // Štatistiky
  totalScraped    Int      @default(0)
  totalNew        Int      @default(0)
  totalUpdated    Int      @default(0)
  totalErrors     Int      @default(0)
  
  // Stav
  isComplete      Boolean  @default(false) // Či prešiel všetky stránky
  lastRunAt       DateTime @default(now())
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  
  // Pre cycling - po dokončení začína odznova
  cycleCount      Int      @default(0) // Koľkokrát prešiel všetko
  
  @@index([source, isComplete])
}

// ==========================================
// SCRAPER RUN LOG - Detailné sledovanie každého behu
// ==========================================

// Dôvod prečo nebol záznam uložený
enum IngestionSkipReason {
  DUPLICATE           // Už existuje v DB (rovnaké external_id)
  INVALID_PRICE       // Cena je 0 alebo nevalidná
  INVALID_AREA        // Plocha je 0 alebo nevalidná
  MISSING_CITY        // Chýba mesto
  MISSING_TITLE       // Chýba názov
  BLOCKED_CONTENT     // Captcha alebo "Ste robot" stránka
  VALIDATION_ERROR    // Iná validačná chyba
  DATABASE_ERROR      // Chyba pri zápise do DB
  SLUG_CONFLICT       // Konflikt slugov
}

// Jeden beh scrapera
model ScraperRun {
  id              String   @id @default(cuid())
  source          String   // "BAZOS", "NEHNUTELNOSTI", "ALL"
  
  // Časy
  startedAt       DateTime @default(now())
  finishedAt      DateTime?
  durationMs      Int?
  
  // Počty - čo sa našlo
  foundCount      Int      @default(0)      // Koľko inzerátov sa našlo v HTML
  
  // Počty - čo sa uložilo
  savedNew        Int      @default(0)      // Nové nehnuteľnosti
  savedUpdated    Int      @default(0)      // Aktualizované (cena sa zmenila)
  savedRelisted   Int      @default(0)      // Re-listingy (vrátené po INACTIVE)
  
  // Počty - čo sa preskočilo (rozdelené podľa dôvodu)
  skippedDuplicate    Int  @default(0)      // Už existuje, bez zmeny
  skippedInvalidPrice Int  @default(0)      // Nevalidná cena
  skippedInvalidArea  Int  @default(0)      // Nevalidná plocha
  skippedMissingCity  Int  @default(0)      // Chýba mesto
  skippedBlocked      Int  @default(0)      // Captcha/blokovaný obsah
  skippedValidation   Int  @default(0)      // Iná validačná chyba
  skippedDbError      Int  @default(0)      // Chyba databázy
  
  // Chyby - detaily
  errors          String?  @db.Text         // JSON array s detailmi chýb
  
  // Stránky
  pagesScraped    Int      @default(0)
  
  // Stav
  status          String   @default("running") // "running", "success", "partial", "failed"
  
  createdAt       DateTime @default(now())
  
  @@index([source, startedAt])
  @@index([status, startedAt])
}

// Dead Letter Queue - zlyhaní záznamy pre analýzu
model FailedScrape {
  id              String   @id @default(cuid())
  scraperRunId    String?  // Prepojenie na ScraperRun
  
  // Identifikácia
  externalId      String   // ID z portálu
  source          String   // "BAZOS", "NEHNUTELNOSTI"
  sourceUrl       String   @db.Text
  
  // Dôvod zlyhania
  failReason      String   // "INVALID_PRICE", "MISSING_CITY", "DATABASE_ERROR", etc.
  errorMessage    String   @db.Text
  errorCode       String?  // Špecifický kód chyby (napr. "P2002" pre Prisma unique constraint)
  
  // Surové dáta pre analýzu
  rawData         String   @db.Text  // JSON - celý ScrapedProperty objekt
  
  // Metadata
  title           String?
  price           Float?
  areaM2          Float?
  city            String?
  
  // Pre opätovné spracovanie
  retryCount      Int      @default(0)
  lastRetryAt     DateTime?
  resolved        Boolean  @default(false)  // Bol problém vyriešený?
  resolvedAt      DateTime?
  resolvedBy      String?  // "auto_retry", "schema_fix", "manual"
  
  createdAt       DateTime @default(now())
  
  @@index([failReason, createdAt])
  @@index([source, createdAt])
  @@index([resolved, createdAt])
  @@index([scraperRunId])
}

// Životný cyklus inzerátu - sledovanie vymazaných/ukončených inzerátov
model PropertyLifecycle {
  id              String   @id @default(cuid())
  
  // Identifikácia pôvodného inzerátu
  externalId      String   // external_id z Property
  source          PropertySource
  city            String            // Mesto/obec
  district        String?
  
  // Údaje o inzeráte
  title           String
  initialPrice    Float    // Počiatočná cena
  finalPrice      Float    // Posledná známa cena
  priceChange     Float    // Zmena ceny počas životnosti (finalPrice - initialPrice)
  priceChangePercent Float // Zmena v percentách
  area_m2         Float
  rooms           Int?
  condition       PropertyCondition?
  listingType     ListingType
  
  // Časové údaje
  firstSeenAt     DateTime // Kedy sme ho prvýkrát videli
  lastSeenAt      DateTime // Kedy sme ho naposledy videli
  daysOnMarket    Int      // Koľko dní bol v ponuke
  
  // Status
  status          ListingStatus @default(REMOVED)
  removalReason   String?  // "sold", "withdrawn", "expired", "unknown"
  
  createdAt       DateTime @default(now())
  
  @@unique([source, externalId])
  @@index([city, status])
  @@index([source, createdAt])
  @@index([daysOnMarket])
  @@index([listingType, city])
}

enum ListingStatus {
  ACTIVE
  REMOVED
  SOLD
  WITHDRAWN
  EXPIRED
}

// Denné štatistiky trhu - agregované dáta
model DailyMarketStats {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  city            String
  listingType     ListingType
  
  // Počty
  totalListings   Int      // Celkový počet aktívnych inzerátov
  newListings     Int      // Nové inzeráty za deň
  removedListings Int      // Vymazané inzeráty za deň
  
  // Cenové štatistiky
  avgPrice        Float    // Priemerná cena
  medianPrice     Float    // Mediánová cena
  avgPricePerM2   Float    // Priemerná cena za m²
  medianPricePerM2 Float   // Mediánová cena za m²
  minPrice        Float
  maxPrice        Float
  
  // Zmeny oproti predchádzajúcemu dňu
  priceChangePercent Float? // Zmena priemernej ceny oproti včera
  listingsChangePercent Float? // Zmena počtu inzerátov oproti včera
  
  // Doba v ponuke
  avgDaysOnMarket Float    // Priemerná doba v ponuke
  
  // Hot deals
  hotDealsCount   Int      // Počet hot deals
  hotDealsPercent Float    // Percento hot deals
  
  createdAt       DateTime @default(now())
  
  @@unique([date, city, listingType])
  @@index([city, date])
  @@index([listingType, date])
}

// Mesačné štatistiky - dlhodobé trendy
model MonthlyMarketStats {
  id              String   @id @default(cuid())
  year            Int
  month           Int
  city            String
  listingType     ListingType
  
  // Agregované dáta
  avgPrice        Float
  medianPrice     Float
  avgPricePerM2   Float
  medianPricePerM2 Float
  
  totalListings   Int      // Priemerný počet aktívnych inzerátov
  totalNew        Int      // Celkový počet nových za mesiac
  totalRemoved    Int      // Celkový počet vymazaných za mesiac
  
  avgDaysOnMarket Float    // Priemerná doba v ponuke
  
  // Zmeny oproti predchádzajúcemu mesiacu
  priceChangePercent Float?
  
  createdAt       DateTime @default(now())
  
  @@unique([year, month, city, listingType])
  @@index([city, year, month])
}
